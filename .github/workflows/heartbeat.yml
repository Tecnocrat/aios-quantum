name: Quantum Heartbeat

# AINLP.pattern: quantum-heartbeat-automation
# AINLP.layer: tachyonic-field-mutation
# Grant workflow permission to push commits
permissions:
  contents: write

on:
  # Scheduled runs use SIMULATOR (disabled by default - enable when needed)
  # schedule:
  #   - cron: '0 * * * *'
  
  # Manual trigger - defaults to REAL QUANTUM
  workflow_dispatch:
    inputs:
      use_simulator:
        description: 'Use simulator instead of real quantum'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'
      backend_override:
        description: 'Backend: ibm_torino (fastest), ibm_fez, ibm_marrakesh (slowest)'
        required: false
        default: 'ibm_torino'
        type: choice
        options:
          - 'ibm_torino'
          - 'ibm_fez'
          - 'ibm_marrakesh'
          - ''

env:
  # Available backends for your account (Heron processors):
  # - ibm_torino: 133q, usually fastest queue
  # - ibm_fez: 156q, moderate queue  
  # - ibm_marrakesh: 156q, often very busy (10k+ queue)
  BACKEND_ROTATION: "ibm_torino,ibm_fez"

jobs:
  heartbeat:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Ensure the checkout action leaves credentials for pushes
          persist-credentials: true
          # Explicitly provide the token
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install qiskit qiskit-ibm-runtime python-dotenv
          pip install -e .
      
      - name: Run heartbeat
        env:
          IBM_QUANTUM_TOKEN: ${{ secrets.IBM_QUANTUM_TOKEN }}
          IBM_QUANTUM_CHANNEL: ${{ secrets.IBM_QUANTUM_CHANNEL }}
          IBM_QUANTUM_INSTANCE: ${{ secrets.IBM_QUANTUM_INSTANCE }}
          USE_SIMULATOR: ${{ github.event.inputs.use_simulator || 'false' }}
          BACKEND_OVERRIDE: ${{ github.event.inputs.backend_override || '' }}
        run: |
          python -c "
          import os
          from aios_quantum.heartbeat import QuantumHeartbeat, HeartbeatConfig
          
          # Determine if using simulator
          use_sim = os.environ.get('USE_SIMULATOR', 'false').lower() == 'true'
          backend_override = os.environ.get('BACKEND_OVERRIDE', '').strip()
          
          # Parse backend rotation from env (empty = auto-discover)
          rotation_str = os.environ.get('BACKEND_ROTATION', '')
          backend_rotation = [b.strip() for b in rotation_str.split(',') if b.strip()]
          
          # Override rotation if specific backend requested
          if backend_override:
              backend_rotation = [backend_override]
              print(f'Using override backend: {backend_override}')
          elif backend_rotation:
              print(f'Backend rotation: {backend_rotation}')
          else:
              print('Auto-discovery mode: will find available backends')
          
          config = HeartbeatConfig(
              use_simulator=use_sim,
              num_qubits=5,
              shots=1024,
              # None or empty list triggers auto-discovery
              backend_rotation=backend_rotation if (backend_rotation and not use_sim) else None,
          )
          
          heartbeat = QuantumHeartbeat(config)
          result = heartbeat.single_beat()
          
          if result:
              print(f'âœ“ Heartbeat complete')
              print(f'  Source: {result.source}')
              print(f'  Backend: {result.backend_name}')
              print(f'  Family: {result.backend_family} {result.backend_processor}')
              print(f'  Coherence: {result.coherence_estimate:.4f}')
          else:
              print('âœ— Heartbeat failed')
              exit(1)
          "
      
      - name: Commit results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add heartbeat_results/
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git commit -m "ðŸ’“ Heartbeat $(date -u +'%Y-%m-%d %H:%M') UTC"
          # Pull with rebase to handle concurrent commits (long quantum jobs)
          git pull --rebase origin ${{ github.ref_name }} || true
          # Push with retry
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
